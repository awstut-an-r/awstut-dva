<html>
  <head>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1033.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-js@1.1.0/dist/amazon-cognito.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@5.2.3/dist/amazon-cognito-identity.min.js"></script>
  </head>
  <body>
    <h1>signin.html</h1>
    <p id="name"></p>
    <p id="parameter"></p>
    
    <h2>Cognito Sync Test</h2>
    <form>
      background-color: <input type="text" id="background-color">
      <button type="button" id="button-set">set background-color</button>
    </form>
    <button type="button" id="button-get">get background-color</button>
    
    
    <script type="text/javascript">
      var prefix = 'dva-03-001'
      var region = 'ap-northeast-1'
      var userPoolId = 'ap-northeast-1_LCLoZND22'
      var identityPoolId = 'ap-northeast-1:800ca6c3-73fb-4c6f-ae5e-e0a91e7fb994'
      
      try {
        // get id token.
        var params = new URLSearchParams(location.hash.slice(1));
        var idToken = params.get("id_token");
        
        AWS.config.region = region;
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: identityPoolId,
          Logins: {
            [`cognito-idp.${region}.amazonaws.com/${userPoolId}`]: idToken
          }
        });
        //console.log(AWS.config.credentials);
        
        var tokens = idToken.split('.');
        var tokensDecoded = JSON.parse(atob(tokens[1]));
        //console.log(tokensDecoded);
        var name = tokensDecoded.name;
        //console.log(name);
        document.getElementById('name').innerText = `Name: ${name}`;
        
        
        //var ssmParams = {
        //  Name: `${prefix}-authenticated`
        //}
        //var ssm = new AWS.SSM();
        //ssm.getParameter(ssmParams, function(err, data) {
        //  if (err) console.log(err, err.stack);
        //  else {
        //    //console.log(data):
        //    var storedParameter = data.Parameter.Value;
        //    //console.log(storedParameter);
        //    document.getElementById('parameter').innerText = `SSM Parameter Store: ${storedParameter}`;
        //  }
        //});
        
        
        var setBackgroundColorToCognitoSync = function(color) {
          AWS.config.credentials.get(function() {
            var syncClient = new AWS.CognitoSyncManager();
            syncClient.openOrCreateDataset('preference', function(err, dataset) {
              dataset.put('background-color', color, function(err, record) {
                dataset.synchronize({
                  onSuccess: function(data, newRecords) {
                    console.log(color);
                    document.body.style.background = color;
                  }
                });
              });
            });
          });
        };
        
        var getBackgroundColorFromCognitoSync = function() {
          AWS.config.credentials.get(function() {
            var syncClient = new AWS.CognitoSyncManager();
            syncClient.openOrCreateDataset('preference', function(err, dataset) {
              dataset.get('background-color', function(err, record) {
                dataset.synchronize({
                  onSuccess: function(data, newRecords) {
                    console.log(record);
                    document.body.style.background = record;
                  }
                });
              });
            });
          });
        };
        
        document.getElementById('button-set').addEventListener('click', function(event) {
          //console.log('hogehogehoge');
          var color = document.getElementById('background-color').value;
          console.log(color);
          setBackgroundColorToCognitoSync(color);
        });
        
        document.getElementById('button-get').addEventListener('click', function(event) {
          //console.log('fugafugafuga');
          getBackgroundColorFromCognitoSync();
        });
        
        
      } catch(e) {
        document.getElementById('name').innerText = 'Name: Guest';
        document.getElementById('parameter').innerText = 'Deny access to SSM Parameter Store.';
      }
    </script>
  </body>
</html>